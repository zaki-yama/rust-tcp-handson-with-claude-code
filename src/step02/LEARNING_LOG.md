# Step 2 Learning Log

## `#[repr(C, packed)]` について

### 質問内容

#[repr(C, packed)]とはなんですか？これはなぜ必要なんですか？

### 回答

#### 定義
- **`#[repr(C)]`**: 構造体のメモリレイアウトをC言語と同じにする
- **`packed`**: フィールド間のアライメント用の空白バイトを削除

#### 必要性
1. **ネットワークプロトコルの要求**: TCPヘッダーは厳密に20バイトと定義
2. **バイナリデータとの一致**: 受信バイト列と構造体レイアウトが完全一致する必要
3. **メモリ効率**: パディングなしで正確なサイズを実現

#### 例：通常 vs packed
```rust
// 通常の構造体 (アライメント付き)
struct Normal {
    a: u16,  // 2バイト + 2バイト padding
    b: u32,  // 4バイト
    // 合計: 8バイト
}

// packed構造体  
#[repr(C, packed)]
struct Packed {
    a: u16,  // 2バイト
    b: u32,  // 4バイト (パディングなし)
    // 合計: 6バイト
}
```

#### デメリット
1. **パフォーマンス**: 非アライメントアクセスは遅い
2. **安全性**: 参照作成時にUB (Undefined Behavior) のリスク  
3. **テストの複雑さ**: 直接フィールドアクセスができない

## TCP疑似ヘッダーとRFC関係について

### 質問内容

**質問1**: D1のTCP疑似ヘッダーというのをまだ理解していません。これは何を指していますか？

**質問2**: TCP疑似ヘッダーについて定義されているRFCはどれですか？
https://www.rfc-editor.org/rfc/rfc9293.html#section-3.1-6.18.1 にも記載がありますが、それとRFC1071との関係がわかりません

### 回答

#### TCP疑似ヘッダーとは
TCPチェックサム計算のために**仮想的に作られるヘッダー**で、実際のパケットには含まれない。チェックサム計算時にだけ使用される。

#### 目的
- IP層の情報（送信元IP、宛先IP）もチェックサムに含めることで、パケットが正しい宛先に届いていることを検証
- 誤配送されたセグメントからの保護

#### 疑似ヘッダーの構造（12バイト）
```
 0      7 8     15 16    23 24    31 
+--------+--------+--------+--------+
|           Source Address          |  ← 送信元IPアドレス（4バイト）
+--------+--------+--------+--------+
|         Destination Address       |  ← 宛先IPアドレス（4バイト）
+--------+--------+--------+--------+
|  zero  |  PTCL  |    TCP Length   |  ← 0パディング(1) + プロトコル番号(1) + TCP長(2)
+--------+--------+--------+--------+
```

#### RFC間の関係
- **RFC 9293（TCPプロトコル仕様）**: 「何を」チェックサム計算に含めるかを定義
  - 疑似ヘッダーの構成要素（IPアドレス、プロトコル番号、TCP長）
  - 疑似ヘッダーの目的（誤配送防止）

- **RFC 1071（チェックサム計算アルゴリズム）**: 「どうやって」チェックサムを計算するかを定義
  - 16bitワード単位の1の補数和の計算手順
  - 効率的な実装技術とパフォーマンス最適化

#### 計算の流れ
1. RFC 9293に従って疑似ヘッダーを構築（12バイト）
2. TCPヘッダーのチェックサムフィールドを0にクリア  
3. 疑似ヘッダー + TCPヘッダー + TCPデータ を連結
4. RFC 1071のアルゴリズムでチェックサム計算を実行
5. 結果をTCPヘッダーのチェックサムフィールドに設定

#### 実例
送信元IP: `192.168.1.1` (0xC0A80101)、宛先IP: `192.168.1.100` (0xC0A80164)、TCP長: 20バイト

疑似ヘッダー:
```
C0 A8 01 01  ← 192.168.1.1
C0 A8 01 64  ← 192.168.1.100  
00 06 00 14  ← 0 + プロトコル6 + 長さ20
```
