# Step03 å­¦ç¿’ãƒ­ã‚°: 3-way handshakeå®Ÿè£…

## å­¦ç¿’ç›®æ¨™
TCPæ¥ç¶šç¢ºç«‹ã®åŸºæœ¬ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ3-way handshakeï¼‰ã‚’å®Ÿè£…ã—ã€å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹

```mermaid
sequenceDiagram
    participant C as Client<br/>(Your Code)
    participant S as Server

    Note over C: State: CLOSED
    Note over S: State: LISTEN

    C->>+S: 1. SYN<br/>seq=100, ack=0<br/>flags=0x02
    Note over C: State: SYN-SENT
    Note over S: State: SYN-RECEIVED

    S->>+C: 2. SYN-ACK<br/>seq=200, ack=101<br/>flags=0x12
    Note over C: â­ Task D3:<br/>ã“ã®æ™‚ç‚¹ã§æ¤œè¨¼

    C->>S: 3. ACK<br/>seq=101, ack=201<br/>flags=0x10
    Note over C: State: ESTABLISHED
    Note over S: State: ESTABLISHED

    Note over C,S: æ¥ç¶šç¢ºç«‹å®Œäº†ï¼
```

## [create_syn_packetç­‰ã®é–¢æ•°ã®å‹è¨­è¨ˆã«ã¤ã„ã¦]

### è³ªå•å†…å®¹

é€”ä¸­ã§è­°è«–ã—ãŸã€create_syn_packetç­‰ã®é–¢æ•°ã®å‹ã®è¨­è¨ˆã«ã¤ã„ã¦ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¦ãŠãã¾ã—ã‚‡ã†

### å›ç­”

#### è¨­è¨ˆã®å¤‰é·ã¨è­°è«–

**æœ€åˆã®è¨­è¨ˆï¼ˆå‹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼‰**ï¼š
```rust
fn send_tcp_packet(&self, tcp_header: &TcpHeader, data: &[u8])
fn create_syn_packet(&self) -> Result<Vec<u8>, Box<dyn std::error::Error>>
fn send_syn(&mut self) -> Result<(), Box<dyn std::error::Error>> {
    let syn_packet = self.create_syn_packet();
    self.send_tcp_packet(&syn_packet, &[])?; // â† å‹ã‚¨ãƒ©ãƒ¼ï¼š&Vec<u8> vs &TcpHeader
}
```

**ä¸­é–“æ¡ˆï¼ˆTcpHeaderã‚’è¿”ã™è¨­è¨ˆï¼‰**ï¼š
```rust
fn create_syn_packet(&self) -> Result<TcpHeader, Box<dyn std::error::Error>>
fn send_syn(&mut self) -> Result<(), Box<dyn std::error::Error>> {
    let syn_header = self.create_syn_packet()?;
    self.send_tcp_packet(&syn_header, &[])?;
}
```

**æœ€çµ‚è¨­è¨ˆï¼ˆæ¦‚å¿µçš„ã«æ­£ã—ã„è¨­è¨ˆï¼‰**ï¼š
```rust
fn send_tcp_packet(&self, tcp_header_bytes: &[u8], data: &[u8])
fn create_syn_packet(&self) -> Result<Vec<u8>, Box<dyn std::error::Error>>
fn send_syn(&mut self) -> Result<(), Box<dyn std::error::Error>> {
    let syn_packet = self.create_syn_packet()?;
    self.send_tcp_packet(&syn_packet, &[])?;
}
```

#### æ¦‚å¿µçš„ãªé•ã„ã®ç†è§£

**TcpHeaderï¼ˆæ§‹é€ ä½“ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰**:
- TCPãƒ˜ãƒƒãƒ€ãƒ¼ã®**æ§‹é€ åŒ–ã•ã‚ŒãŸè¡¨ç¾**
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åå‰ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆ`header.source_port`ãªã©ï¼‰
- ãƒã‚§ãƒƒã‚¯ã‚µãƒ è¨ˆç®—ãªã©ã®**æ“ä½œ**ãŒã§ãã‚‹
- ãƒ¡ãƒ¢ãƒªä¸Šã§ã®**ãƒ‡ãƒ¼ã‚¿æ§‹é€ **

**Packetï¼ˆãƒã‚¤ãƒˆåˆ—ï¼‰**:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§**å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å½¢å¼**
- ãƒã‚¤ãƒˆé…åˆ—ï¼ˆ`Vec<u8>`ã‚„`&[u8]`ï¼‰
- ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆwire formatï¼‰
- ç›´æ¥socketé€ä¿¡å¯èƒ½

#### TCP/IPãƒ‘ã‚±ãƒƒãƒˆæ§‹é€ ã®ç†è§£

```
ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å®Œå…¨ãªãƒ‘ã‚±ãƒƒãƒˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Complete IP Packet                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (20 bytes)     â”‚   (20 bytes)     â”‚   (variable length)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç”¨èªã®æ­£ç¢ºãªå®šç¾©**ï¼š
- **IP Packet (IP Datagram)**: IP Header + IP Payload
- **TCP Packet/Segment**: TCP Header + Application Dataï¼ˆIPãƒ˜ãƒƒãƒ€ãƒ¼å«ã¾ãšï¼‰

#### æœ€çµ‚è¨­è¨ˆã®åˆ©ç‚¹

1. **å‘½åã¨å®Ÿè£…ãŒä¸€è‡´**: ã€Œpacketã€ã¨ã„ã†åå‰ã§ãƒã‚¤ãƒˆåˆ—ã‚’è¿”ã™
2. **æ‹¡å¼µæ€§**: å°†æ¥ACK/FINãƒ‘ã‚±ãƒƒãƒˆã§ã‚‚åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä½¿ãˆã‚‹
3. **ãƒ†ã‚¹ãƒˆã®è‡ªç„¶ã•**: ãƒã‚¤ãƒˆåˆ—ã¨ã—ã¦ç›´æ¥æ¤œè¨¼å¯èƒ½
4. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¦‚å¿µã®ä¸€è‡´**: ãƒ‘ã‚±ãƒƒãƒˆ = é€ä¿¡å¯èƒ½ãªãƒã‚¤ãƒˆåˆ—

#### å­¦ã‚“ã é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

- **æ¦‚å¿µã®åˆ†é›¢**: æ§‹é€ ä½“ï¼ˆæ“ä½œå¯èƒ½ï¼‰ã¨ãƒã‚¤ãƒˆåˆ—ï¼ˆé€ä¿¡å¯èƒ½ï¼‰ã¯ç•°ãªã‚‹æ¦‚å¿µ
- **å‘½åã®é‡è¦æ€§**: é–¢æ•°åã‹ã‚‰æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã¨å®Ÿè£…ã‚’ä¸€è‡´ã•ã›ã‚‹
- **è¨­è¨ˆã®ä¸€è²«æ€§**: åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä»–ã®ç¨®é¡ã®ãƒ‘ã‚±ãƒƒãƒˆä½œæˆã§ã‚‚é©ç”¨å¯èƒ½

## [tcp_packetã¨tcp_header,ip_headerã®é–¢ä¿‚ã«ã¤ã„ã¦]

### è³ªå•å†…å®¹

tcp_packetã¨tcp_header,ip_headerã®é–¢ä¿‚ã‚’ã‚¢ã‚¹ã‚­ãƒ¼ã‚¢ãƒ¼ãƒˆã®å›³ã«ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„

### å›ç­”

#### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å®Œå…¨ãªãƒ‘ã‚±ãƒƒãƒˆ

```
ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å®Œå…¨ãªãƒ‘ã‚±ãƒƒãƒˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Complete IP Packet                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (20 bytes)     â”‚   (20 bytes)     â”‚   (variable length)   â”‚
â”‚                  â”‚                  â”‚                       â”‚
â”‚ Version: 4       â”‚ Src Port: 12345  â”‚ "Hello, World!"       â”‚
â”‚ Protocol: 6(TCP) â”‚ Dst Port: 80     â”‚ "GET / HTTP/1.1"      â”‚
â”‚ Src IP: 10.0.0.1 â”‚ Seq: 1000        â”‚ ...                   â”‚
â”‚ Dst IP: 10.0.0.2 â”‚ ACK: 0           â”‚                       â”‚
â”‚ Length: 53       â”‚ Flags: SYN       â”‚                       â”‚
â”‚ ...              â”‚ Window: 8192     â”‚                       â”‚
â”‚                  â”‚ Checksum: 0x1234 â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Step3ã®send_tcp_packeté–¢æ•°ã§ã®å‡¦ç†

```
ğŸ“¦ é–¢æ•°å†…ã§ã®ãƒ‘ã‚±ãƒƒãƒˆæ§‹ç¯‰ãƒ—ãƒ­ã‚»ã‚¹

Step 1: å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹éƒ¨åˆ†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   tcp_header_bytes   â”‚      data             â”‚
â”‚   (TCPãƒ˜ãƒƒãƒ€ãƒ¼)       â”‚   (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿)  â”‚
â”‚   [0x30, 0x39,...]  â”‚   "Hello, World!"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: IPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ip_header      â”‚  â† IpHeader::new()ã§ä½œæˆ
â”‚   (è‡ªå‹•ç”Ÿæˆ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: å®Œå…¨ãƒ‘ã‚±ãƒƒãƒˆã«çµåˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (ip_header)    â”‚(tcp_header_bytes)â”‚      (data)           â”‚
â”‚                  â”‚                  â”‚                       â”‚
â”‚ â† IpHeader::new()â”‚ â† å¼•æ•°ã§å—ã‘å–ã£ãŸ â”‚ â† å¼•æ•°ã§å—ã‘å–ã£ãŸ      â”‚
â”‚    ã§è‡ªå‹•ç”Ÿæˆ     â”‚   ãƒã‚¤ãƒˆåˆ—        â”‚   ãƒ‡ãƒ¼ã‚¿              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
                        send_to_network()
```

#### ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®ã€Œãƒ‘ã‚±ãƒƒãƒˆã€æ¦‚å¿µ

```
ğŸ“¦ ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®ã€Œãƒ‘ã‚±ãƒƒãƒˆã€æ¦‚å¿µ

Layer 3 (Network Layer):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IP Header      â”‚            IP Payload                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IP Packet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚

Layer 4 (Transport Layer):
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   TCP Header     â”‚   Application Data    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TCP Packet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
```

#### ç”¨èªã®é–¢ä¿‚

```
ğŸ“‹ æ¦‚å¿µãƒ¬ãƒ™ãƒ«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TCP Packet  â”‚ = TCPå…¨ä½“ã®æ¦‚å¿µï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ + ãƒ‡ãƒ¼ã‚¿ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”§ å®Ÿè£…ãƒ¬ãƒ™ãƒ«  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TcpHeader       â”‚  Application Data     â”‚
â”‚  (æ§‹é€ ä½“/ãƒã‚¤ãƒˆåˆ—) â”‚  (ãƒã‚¤ãƒˆåˆ—)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (IP Packet)    â”‚                  â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é‡è¦ãªç†è§£ãƒã‚¤ãƒ³ãƒˆ

**TCPãƒ‘ã‚±ãƒƒãƒˆã®å®šç¾©**ï¼š
- **ä¸€èˆ¬çš„ãªä½¿ã„æ–¹**: ã€ŒTCPãƒ‘ã‚±ãƒƒãƒˆã€= TCP Header + Application Dataï¼ˆIPãƒ˜ãƒƒãƒ€ãƒ¼å«ã¾ãšï¼‰
- **RFCçš„ãªæ­£ç¢ºãªå®šç¾©**: TCP Segment = TCP Header + Application Data

**ãªãœtcp_header_bytesãŒæ­£ç¢ºãªå‘½åã‹**ï¼š
```
âŒ ä¸æ­£ç¢º: tcp_packet
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TCP Header     â”‚   Application Data    â”‚  â† å…¨éƒ¨ã¾ã¨ã‚ã¦"packet"ï¼Ÿ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… æ­£ç¢º: tcp_header_bytes + data  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TCP Header     â”‚ â”‚   Application Data    â”‚
â”‚(tcp_header_bytes)â”‚ â”‚      (data)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                     â†‘
   æ˜ç¢ºã«åˆ†é›¢ã•ã‚ŒãŸå¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
```

## Phase A: 3-way handshakeã®ç†è§£ã¨è¨­è¨ˆ

### Task A1: RFC 9293 Section 3.5ã®ç†è§£

#### 3-way handshakeã®ãƒ•ãƒ­ãƒ¼
```
Client                           Server
CLOSED                           LISTEN
  |                                |
  | -- SYN seq=x -->              |
  |                               | 
SYN-SENT                          |
  |                              | -- SYN-ACK seq=y, ack=x+1 -->
  |                           SYN-RECEIVED
  | <-- SYN-ACK seq=y, ack=x+1 --|
  |                               |
  | -- ACK seq=x+1, ack=y+1 -->  |
  |                               |
ESTABLISHED                   ESTABLISHED
```

#### å„ãƒ‘ã‚±ãƒƒãƒˆã®æ„å‘³
- **SYN**: æ¥ç¶šé–‹å§‹è¦æ±‚ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·(x)ã‚’é€šçŸ¥
- **SYN-ACK**: æ¥ç¶šå—è«¾ + ã‚µãƒ¼ãƒãƒ¼ã®åˆæœŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·(y) + ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®SYNã«å¯¾ã™ã‚‹ACK(x+1)
- **ACK**: æ¥ç¶šç¢ºç«‹å®Œäº†ã€‚ã‚µãƒ¼ãƒãƒ¼ã®SYNã«å¯¾ã™ã‚‹ACK(y+1)

### Task A2: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã¨ACKç•ªå·ã®è¨ˆç®—ãƒ«ãƒ¼ãƒ«

| ãƒ‘ã‚±ãƒƒãƒˆ | seqç•ªå· | ackç•ªå· | èª¬æ˜ |
|----------|---------|---------|------|
| SYN | ISN_client (x) | 0 | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹ |
| SYN-ACK | ISN_server (y) | x+1 | ã‚µãƒ¼ãƒãƒ¼ã®åˆæœŸseq + ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆseqã‚’ACK |
| ACK | x+1 | y+1 | ä¸¡æ–¹ã®ISNã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦ACK |

#### é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ
- SYNãƒ•ãƒ©ã‚°è‡ªä½“ãŒ1ãƒã‚¤ãƒˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ï¼ˆseqç•ªå·ã‚’+1ã™ã‚‹ï¼‰
- ACKç•ªå·ã¯ã€Œæ¬¡ã«å—ä¿¡ã‚’æœŸå¾…ã™ã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã€
- ISNï¼ˆInitial Sequence Numberï¼‰ã¯å®‰å…¨æ€§ã®ãŸã‚ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ

### Task A3: æ¥ç¶šçŠ¶æ…‹ã®ç†è§£

```rust
#[derive(Debug, Clone, PartialEq)]
pub enum TcpState {
    Closed,      // åˆæœŸçŠ¶æ…‹ã€æ¥ç¶šãªã—
    SynSent,     // SYNé€ä¿¡æ¸ˆã¿ã€SYN-ACKå¾…ã¡
    Established, // æ¥ç¶šç¢ºç«‹å®Œäº†
}
```

#### çŠ¶æ…‹é·ç§»
- CLOSED â†’ SYN-SENT: SYNãƒ‘ã‚±ãƒƒãƒˆé€ä¿¡æ™‚
- SYN-SENT â†’ ESTABLISHED: æ­£ã—ã„SYN-ACKå—ä¿¡å¾Œã€ACKé€ä¿¡å®Œäº†æ™‚

## [ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã®æ„å‘³ã¨MSG_DONTWAITãƒ•ãƒ©ã‚°ã«ã¤ã„ã¦]

### è³ªå•å†…å®¹

ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã®æ„å‘³ãŒã‚ˆãã‚ã‹ã£ã¦ãªã„ã®ã§ã™ãŒã€libc::MSG_DONTWAITã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§æŒ™å‹•ãŒã©ã®ã‚ˆã†ã«å¤‰ã‚ã‚‹ã®ã§ã™ã‹ï¼Ÿ

### å›ç­”

#### MSG_DONTWAITãªã—ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
```rust
// ãƒ•ãƒ©ã‚°ãªã—ã€ã¾ãŸã¯ãƒ•ãƒ©ã‚°ã«0ã‚’æŒ‡å®š
let bytes_received = unsafe {
    libc::recv(
        self.socket_fd,
        buffer.as_mut_ptr() as *mut libc::c_void,
        buffer.len(),
        0, // ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
    )
};
```

**æŒ™å‹•**:
- ãƒ‘ã‚±ãƒƒãƒˆãŒæ¥ã‚‹ã¾ã§**ç„¡é™ã«å¾…æ©Ÿ**
- ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã“ã“ã§**å®Œå…¨ã«åœæ­¢**
- ãƒ‘ã‚±ãƒƒãƒˆãŒå±Šã„ãŸã‚‰ã‚„ã£ã¨æ¬¡ã®è¡Œã«é€²ã‚€

#### MSG_DONTWAITã‚ã‚Šï¼ˆãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
```rust
let bytes_received = unsafe {
    libc::recv(
        self.socket_fd,
        buffer.as_mut_ptr() as *mut libc::c_void,
        buffer.len(),
        libc::MSG_DONTWAIT, // ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
    )
};
```

**æŒ™å‹•**:
- ãƒ‘ã‚±ãƒƒãƒˆãŒã‚ã‚Œã°**å³åº§ã«å—ä¿¡ã—ã¦è¿”ã™**
- ãƒ‘ã‚±ãƒƒãƒˆãŒãªã‘ã‚Œã°**å³åº§ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™**ï¼ˆå¾…æ©Ÿã—ãªã„ï¼‰
- ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯çµ¶å¯¾ã«æ­¢ã¾ã‚‰ãªã„

#### å®Ÿéš›ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼æ¯”è¼ƒ

**ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆ**:
```rust
println!("å—ä¿¡é–‹å§‹...");
let packet = recv(); // â† ã“ã“ã§æ°¸ä¹…ã«æ­¢ã¾ã‚‹å¯èƒ½æ€§
println!("ãƒ‘ã‚±ãƒƒãƒˆå—ä¿¡å®Œäº†ï¼"); // ãƒ‘ã‚±ãƒƒãƒˆãŒæ¥ã‚‹ã¾ã§å®Ÿè¡Œã•ã‚Œãªã„
```

**ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆ**:
```rust
println!("å—ä¿¡é–‹å§‹...");
match recv() {
    Ok(packet) => println!("ãƒ‘ã‚±ãƒƒãƒˆå—ä¿¡å®Œäº†ï¼"),
    Err(_) => println!("ãƒ‘ã‚±ãƒƒãƒˆãªã—ã€ä»–ã®å‡¦ç†ã‚’ç¶šè¡Œ"),
}
// å¿…ãšã“ã“ã¾ã§å®Ÿè¡Œã•ã‚Œã‚‹
```

#### receive_packet_timeoutã§ã®æ´»ç”¨

```rust
fn receive_packet_timeout(&self, timeout_secs: u64) -> Result<Vec<u8>, Box<dyn std::error::Error>> {
    let start = Instant::now();
    
    loop {
        // ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã§å—ä¿¡è©¦è¡Œ
        match self.try_receive_packet() {
            Ok(data) => return Ok(data),        // ãƒ‘ã‚±ãƒƒãƒˆãŒã‚ã£ãŸ
            Err(_) => {                         // ãƒ‘ã‚±ãƒƒãƒˆãŒãªã‹ã£ãŸ
                if start.elapsed() > timeout {
                    return Err("Timeout".into()); // åˆ¶é™æ™‚é–“è¶…é
                }
                std::thread::sleep(Duration::from_millis(10)); // å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
            }
        }
    }
}
```

#### ãªãœãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãŒå¿…è¦ï¼Ÿ

**3-way handshakeã§ã¯**:
1. SYNé€ä¿¡
2. **5ç§’ä»¥å†…ã«**SYN-ACKå—ä¿¡ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ãŒå¿…è¦ï¼‰
3. ACKé€ä¿¡

ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆã ã¨ã€SYN-ACKãŒæ¥ãªã„å ´åˆã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ°¸ä¹…ã«æ­¢ã¾ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆãªã‚‰ã€10msæ¯ã«ãƒ‘ã‚±ãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¤ã¤ã€5ç§’çµŒã£ãŸã‚‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ãã¾ã™ã€‚
