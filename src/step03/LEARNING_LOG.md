# Step03 å­¦ç¿’ãƒ­ã‚°: 3-way handshakeå®Ÿè£…

## å­¦ç¿’ç›®æ¨™
TCPæ¥ç¶šç¢ºç«‹ã®åŸºæœ¬ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆ3-way handshakeï¼‰ã‚’å®Ÿè£…ã—ã€å®Ÿéš›ã®ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹

```mermaid
sequenceDiagram
    participant C as Client<br/>(Your Code)
    participant S as Server

    Note over C: State: CLOSED
    Note over S: State: LISTEN

    C->>+S: 1. SYN<br/>seq=100, ack=0<br/>flags=0x02
    Note over C: State: SYN-SENT
    Note over S: State: SYN-RECEIVED

    S->>+C: 2. SYN-ACK<br/>seq=200, ack=101<br/>flags=0x12
    Note over C: â­ Task D3:<br/>ã“ã®æ™‚ç‚¹ã§æ¤œè¨¼

    C->>S: 3. ACK<br/>seq=101, ack=201<br/>flags=0x10
    Note over C: State: ESTABLISHED
    Note over S: State: ESTABLISHED

    Note over C,S: æ¥ç¶šç¢ºç«‹å®Œäº†ï¼
```

## [create_syn_packetç­‰ã®é–¢æ•°ã®å‹è¨­è¨ˆã«ã¤ã„ã¦]

### è³ªå•å†…å®¹

é€”ä¸­ã§è­°è«–ã—ãŸã€create_syn_packetç­‰ã®é–¢æ•°ã®å‹ã®è¨­è¨ˆã«ã¤ã„ã¦ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¦ãŠãã¾ã—ã‚‡ã†

### å›ç­”

#### è¨­è¨ˆã®å¤‰é·ã¨è­°è«–

**æœ€åˆã®è¨­è¨ˆï¼ˆå‹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼‰**ï¼š
```rust
fn send_tcp_packet(&self, tcp_header: &TcpHeader, data: &[u8])
fn create_syn_packet(&self) -> Result<Vec<u8>, Box<dyn std::error::Error>>
fn send_syn(&mut self) -> Result<(), Box<dyn std::error::Error>> {
    let syn_packet = self.create_syn_packet();
    self.send_tcp_packet(&syn_packet, &[])?; // â† å‹ã‚¨ãƒ©ãƒ¼ï¼š&Vec<u8> vs &TcpHeader
}
```

**ä¸­é–“æ¡ˆï¼ˆTcpHeaderã‚’è¿”ã™è¨­è¨ˆï¼‰**ï¼š
```rust
fn create_syn_packet(&self) -> Result<TcpHeader, Box<dyn std::error::Error>>
fn send_syn(&mut self) -> Result<(), Box<dyn std::error::Error>> {
    let syn_header = self.create_syn_packet()?;
    self.send_tcp_packet(&syn_header, &[])?;
}
```

**æœ€çµ‚è¨­è¨ˆï¼ˆæ¦‚å¿µçš„ã«æ­£ã—ã„è¨­è¨ˆï¼‰**ï¼š
```rust
fn send_tcp_packet(&self, tcp_header_bytes: &[u8], data: &[u8])
fn create_syn_packet(&self) -> Result<Vec<u8>, Box<dyn std::error::Error>>
fn send_syn(&mut self) -> Result<(), Box<dyn std::error::Error>> {
    let syn_packet = self.create_syn_packet()?;
    self.send_tcp_packet(&syn_packet, &[])?;
}
```

#### æ¦‚å¿µçš„ãªé•ã„ã®ç†è§£

**TcpHeaderï¼ˆæ§‹é€ ä½“ãƒ»ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰**:
- TCPãƒ˜ãƒƒãƒ€ãƒ¼ã®**æ§‹é€ åŒ–ã•ã‚ŒãŸè¡¨ç¾**
- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åå‰ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆ`header.source_port`ãªã©ï¼‰
- ãƒã‚§ãƒƒã‚¯ã‚µãƒ è¨ˆç®—ãªã©ã®**æ“ä½œ**ãŒã§ãã‚‹
- ãƒ¡ãƒ¢ãƒªä¸Šã§ã®**ãƒ‡ãƒ¼ã‚¿æ§‹é€ **

**Packetï¼ˆãƒã‚¤ãƒˆåˆ—ï¼‰**:
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§**å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å½¢å¼**
- ãƒã‚¤ãƒˆé…åˆ—ï¼ˆ`Vec<u8>`ã‚„`&[u8]`ï¼‰
- ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆwire formatï¼‰
- ç›´æ¥socketé€ä¿¡å¯èƒ½

#### TCP/IPãƒ‘ã‚±ãƒƒãƒˆæ§‹é€ ã®ç†è§£

```
ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å®Œå…¨ãªãƒ‘ã‚±ãƒƒãƒˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Complete IP Packet                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (20 bytes)     â”‚   (20 bytes)     â”‚   (variable length)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç”¨èªã®æ­£ç¢ºãªå®šç¾©**ï¼š
- **IP Packet (IP Datagram)**: IP Header + IP Payload
- **TCP Packet/Segment**: TCP Header + Application Dataï¼ˆIPãƒ˜ãƒƒãƒ€ãƒ¼å«ã¾ãšï¼‰

#### æœ€çµ‚è¨­è¨ˆã®åˆ©ç‚¹

1. **å‘½åã¨å®Ÿè£…ãŒä¸€è‡´**: ã€Œpacketã€ã¨ã„ã†åå‰ã§ãƒã‚¤ãƒˆåˆ—ã‚’è¿”ã™
2. **æ‹¡å¼µæ€§**: å°†æ¥ACK/FINãƒ‘ã‚±ãƒƒãƒˆã§ã‚‚åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä½¿ãˆã‚‹
3. **ãƒ†ã‚¹ãƒˆã®è‡ªç„¶ã•**: ãƒã‚¤ãƒˆåˆ—ã¨ã—ã¦ç›´æ¥æ¤œè¨¼å¯èƒ½
4. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¦‚å¿µã®ä¸€è‡´**: ãƒ‘ã‚±ãƒƒãƒˆ = é€ä¿¡å¯èƒ½ãªãƒã‚¤ãƒˆåˆ—

#### å­¦ã‚“ã é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ

- **æ¦‚å¿µã®åˆ†é›¢**: æ§‹é€ ä½“ï¼ˆæ“ä½œå¯èƒ½ï¼‰ã¨ãƒã‚¤ãƒˆåˆ—ï¼ˆé€ä¿¡å¯èƒ½ï¼‰ã¯ç•°ãªã‚‹æ¦‚å¿µ
- **å‘½åã®é‡è¦æ€§**: é–¢æ•°åã‹ã‚‰æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã¨å®Ÿè£…ã‚’ä¸€è‡´ã•ã›ã‚‹
- **è¨­è¨ˆã®ä¸€è²«æ€§**: åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä»–ã®ç¨®é¡ã®ãƒ‘ã‚±ãƒƒãƒˆä½œæˆã§ã‚‚é©ç”¨å¯èƒ½

## [tcp_packetã¨tcp_header,ip_headerã®é–¢ä¿‚ã«ã¤ã„ã¦]

### è³ªå•å†…å®¹

tcp_packetã¨tcp_header,ip_headerã®é–¢ä¿‚ã‚’ã‚¢ã‚¹ã‚­ãƒ¼ã‚¢ãƒ¼ãƒˆã®å›³ã«ã—ã¦èª¬æ˜ã—ã¦ãã ã•ã„

### å›ç­”

#### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å®Œå…¨ãªãƒ‘ã‚±ãƒƒãƒˆ

```
ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§å®Ÿéš›ã«é€ä¿¡ã•ã‚Œã‚‹å®Œå…¨ãªãƒ‘ã‚±ãƒƒãƒˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Complete IP Packet                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (20 bytes)     â”‚   (20 bytes)     â”‚   (variable length)   â”‚
â”‚                  â”‚                  â”‚                       â”‚
â”‚ Version: 4       â”‚ Src Port: 12345  â”‚ "Hello, World!"       â”‚
â”‚ Protocol: 6(TCP) â”‚ Dst Port: 80     â”‚ "GET / HTTP/1.1"      â”‚
â”‚ Src IP: 10.0.0.1 â”‚ Seq: 1000        â”‚ ...                   â”‚
â”‚ Dst IP: 10.0.0.2 â”‚ ACK: 0           â”‚                       â”‚
â”‚ Length: 53       â”‚ Flags: SYN       â”‚                       â”‚
â”‚ ...              â”‚ Window: 8192     â”‚                       â”‚
â”‚                  â”‚ Checksum: 0x1234 â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Step3ã®send_tcp_packeté–¢æ•°ã§ã®å‡¦ç†

```
ğŸ“¦ é–¢æ•°å†…ã§ã®ãƒ‘ã‚±ãƒƒãƒˆæ§‹ç¯‰ãƒ—ãƒ­ã‚»ã‚¹

Step 1: å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹éƒ¨åˆ†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   tcp_header_bytes   â”‚      data             â”‚
â”‚   (TCPãƒ˜ãƒƒãƒ€ãƒ¼)       â”‚   (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿)  â”‚
â”‚   [0x30, 0x39,...]  â”‚   "Hello, World!"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: IPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ip_header      â”‚  â† IpHeader::new()ã§ä½œæˆ
â”‚   (è‡ªå‹•ç”Ÿæˆ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: å®Œå…¨ãƒ‘ã‚±ãƒƒãƒˆã«çµåˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (ip_header)    â”‚(tcp_header_bytes)â”‚      (data)           â”‚
â”‚                  â”‚                  â”‚                       â”‚
â”‚ â† IpHeader::new()â”‚ â† å¼•æ•°ã§å—ã‘å–ã£ãŸ â”‚ â† å¼•æ•°ã§å—ã‘å–ã£ãŸ      â”‚
â”‚    ã§è‡ªå‹•ç”Ÿæˆ     â”‚   ãƒã‚¤ãƒˆåˆ—        â”‚   ãƒ‡ãƒ¼ã‚¿              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
                        send_to_network()
```

#### ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®ã€Œãƒ‘ã‚±ãƒƒãƒˆã€æ¦‚å¿µ

```
ğŸ“¦ ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ¥ã®ã€Œãƒ‘ã‚±ãƒƒãƒˆã€æ¦‚å¿µ

Layer 3 (Network Layer):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IP Header      â”‚            IP Payload                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IP Packet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚

Layer 4 (Transport Layer):
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   TCP Header     â”‚   Application Data    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TCP Packet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
```

#### ç”¨èªã®é–¢ä¿‚

```
ğŸ“‹ æ¦‚å¿µãƒ¬ãƒ™ãƒ«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TCP Packet  â”‚ = TCPå…¨ä½“ã®æ¦‚å¿µï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ + ãƒ‡ãƒ¼ã‚¿ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”§ å®Ÿè£…ãƒ¬ãƒ™ãƒ«  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TcpHeader       â”‚  Application Data     â”‚
â”‚  (æ§‹é€ ä½“/ãƒã‚¤ãƒˆåˆ—) â”‚  (ãƒã‚¤ãƒˆåˆ—)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IP Header      â”‚   TCP Header     â”‚   Application Data    â”‚
â”‚   (IP Packet)    â”‚                  â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é‡è¦ãªç†è§£ãƒã‚¤ãƒ³ãƒˆ

**TCPãƒ‘ã‚±ãƒƒãƒˆã®å®šç¾©**ï¼š
- **ä¸€èˆ¬çš„ãªä½¿ã„æ–¹**: ã€ŒTCPãƒ‘ã‚±ãƒƒãƒˆã€= TCP Header + Application Dataï¼ˆIPãƒ˜ãƒƒãƒ€ãƒ¼å«ã¾ãšï¼‰
- **RFCçš„ãªæ­£ç¢ºãªå®šç¾©**: TCP Segment = TCP Header + Application Data

**ãªãœtcp_header_bytesãŒæ­£ç¢ºãªå‘½åã‹**ï¼š
```
âŒ ä¸æ­£ç¢º: tcp_packet
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TCP Header     â”‚   Application Data    â”‚  â† å…¨éƒ¨ã¾ã¨ã‚ã¦"packet"ï¼Ÿ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… æ­£ç¢º: tcp_header_bytes + data  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TCP Header     â”‚ â”‚   Application Data    â”‚
â”‚(tcp_header_bytes)â”‚ â”‚      (data)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                     â†‘
   æ˜ç¢ºã«åˆ†é›¢ã•ã‚ŒãŸå¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
```

## Phase A: 3-way handshakeã®ç†è§£ã¨è¨­è¨ˆ

### Task A1: RFC 9293 Section 3.5ã®ç†è§£

#### 3-way handshakeã®ãƒ•ãƒ­ãƒ¼
```
Client                           Server
CLOSED                           LISTEN
  |                                |
  | -- SYN seq=x -->              |
  |                               | 
SYN-SENT                          |
  |                              | -- SYN-ACK seq=y, ack=x+1 -->
  |                           SYN-RECEIVED
  | <-- SYN-ACK seq=y, ack=x+1 --|
  |                               |
  | -- ACK seq=x+1, ack=y+1 -->  |
  |                               |
ESTABLISHED                   ESTABLISHED
```

#### å„ãƒ‘ã‚±ãƒƒãƒˆã®æ„å‘³
- **SYN**: æ¥ç¶šé–‹å§‹è¦æ±‚ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·(x)ã‚’é€šçŸ¥
- **SYN-ACK**: æ¥ç¶šå—è«¾ + ã‚µãƒ¼ãƒãƒ¼ã®åˆæœŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·(y) + ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®SYNã«å¯¾ã™ã‚‹ACK(x+1)
- **ACK**: æ¥ç¶šç¢ºç«‹å®Œäº†ã€‚ã‚µãƒ¼ãƒãƒ¼ã®SYNã«å¯¾ã™ã‚‹ACK(y+1)

### Task A2: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã¨ACKç•ªå·ã®è¨ˆç®—ãƒ«ãƒ¼ãƒ«

| ãƒ‘ã‚±ãƒƒãƒˆ | seqç•ªå· | ackç•ªå· | èª¬æ˜ |
|----------|---------|---------|------|
| SYN | ISN_client (x) | 0 | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹ |
| SYN-ACK | ISN_server (y) | x+1 | ã‚µãƒ¼ãƒãƒ¼ã®åˆæœŸseq + ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆseqã‚’ACK |
| ACK | x+1 | y+1 | ä¸¡æ–¹ã®ISNã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã—ã¦ACK |

#### é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ
- SYNãƒ•ãƒ©ã‚°è‡ªä½“ãŒ1ãƒã‚¤ãƒˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ï¼ˆseqç•ªå·ã‚’+1ã™ã‚‹ï¼‰
- ACKç•ªå·ã¯ã€Œæ¬¡ã«å—ä¿¡ã‚’æœŸå¾…ã™ã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã€
- ISNï¼ˆInitial Sequence Numberï¼‰ã¯å®‰å…¨æ€§ã®ãŸã‚ãƒ©ãƒ³ãƒ€ãƒ ã«ç”Ÿæˆ

### Task A3: æ¥ç¶šçŠ¶æ…‹ã®ç†è§£

```rust
#[derive(Debug, Clone, PartialEq)]
pub enum TcpState {
    Closed,      // åˆæœŸçŠ¶æ…‹ã€æ¥ç¶šãªã—
    SynSent,     // SYNé€ä¿¡æ¸ˆã¿ã€SYN-ACKå¾…ã¡
    Established, // æ¥ç¶šç¢ºç«‹å®Œäº†
}
```

#### çŠ¶æ…‹é·ç§»
- CLOSED â†’ SYN-SENT: SYNãƒ‘ã‚±ãƒƒãƒˆé€ä¿¡æ™‚
- SYN-SENT â†’ ESTABLISHED: æ­£ã—ã„SYN-ACKå—ä¿¡å¾Œã€ACKé€ä¿¡å®Œäº†æ™‚

## [ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã®æ„å‘³ã¨MSG_DONTWAITãƒ•ãƒ©ã‚°ã«ã¤ã„ã¦]

### è³ªå•å†…å®¹

ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã®æ„å‘³ãŒã‚ˆãã‚ã‹ã£ã¦ãªã„ã®ã§ã™ãŒã€libc::MSG_DONTWAITã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§æŒ™å‹•ãŒã©ã®ã‚ˆã†ã«å¤‰ã‚ã‚‹ã®ã§ã™ã‹ï¼Ÿ

### å›ç­”

#### MSG_DONTWAITãªã—ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
```rust
// ãƒ•ãƒ©ã‚°ãªã—ã€ã¾ãŸã¯ãƒ•ãƒ©ã‚°ã«0ã‚’æŒ‡å®š
let bytes_received = unsafe {
    libc::recv(
        self.socket_fd,
        buffer.as_mut_ptr() as *mut libc::c_void,
        buffer.len(),
        0, // ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
    )
};
```

**æŒ™å‹•**:
- ãƒ‘ã‚±ãƒƒãƒˆãŒæ¥ã‚‹ã¾ã§**ç„¡é™ã«å¾…æ©Ÿ**
- ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒã“ã“ã§**å®Œå…¨ã«åœæ­¢**
- ãƒ‘ã‚±ãƒƒãƒˆãŒå±Šã„ãŸã‚‰ã‚„ã£ã¨æ¬¡ã®è¡Œã«é€²ã‚€

#### MSG_DONTWAITã‚ã‚Šï¼ˆãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
```rust
let bytes_received = unsafe {
    libc::recv(
        self.socket_fd,
        buffer.as_mut_ptr() as *mut libc::c_void,
        buffer.len(),
        libc::MSG_DONTWAIT, // ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°
    )
};
```

**æŒ™å‹•**:
- ãƒ‘ã‚±ãƒƒãƒˆãŒã‚ã‚Œã°**å³åº§ã«å—ä¿¡ã—ã¦è¿”ã™**
- ãƒ‘ã‚±ãƒƒãƒˆãŒãªã‘ã‚Œã°**å³åº§ã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™**ï¼ˆå¾…æ©Ÿã—ãªã„ï¼‰
- ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯çµ¶å¯¾ã«æ­¢ã¾ã‚‰ãªã„

#### å®Ÿéš›ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼æ¯”è¼ƒ

**ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆ**:
```rust
println!("å—ä¿¡é–‹å§‹...");
let packet = recv(); // â† ã“ã“ã§æ°¸ä¹…ã«æ­¢ã¾ã‚‹å¯èƒ½æ€§
println!("ãƒ‘ã‚±ãƒƒãƒˆå—ä¿¡å®Œäº†ï¼"); // ãƒ‘ã‚±ãƒƒãƒˆãŒæ¥ã‚‹ã¾ã§å®Ÿè¡Œã•ã‚Œãªã„
```

**ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆ**:
```rust
println!("å—ä¿¡é–‹å§‹...");
match recv() {
    Ok(packet) => println!("ãƒ‘ã‚±ãƒƒãƒˆå—ä¿¡å®Œäº†ï¼"),
    Err(_) => println!("ãƒ‘ã‚±ãƒƒãƒˆãªã—ã€ä»–ã®å‡¦ç†ã‚’ç¶šè¡Œ"),
}
// å¿…ãšã“ã“ã¾ã§å®Ÿè¡Œã•ã‚Œã‚‹
```

#### receive_packet_timeoutã§ã®æ´»ç”¨

```rust
fn receive_packet_timeout(&self, timeout_secs: u64) -> Result<Vec<u8>, Box<dyn std::error::Error>> {
    let start = Instant::now();
    
    loop {
        // ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã§å—ä¿¡è©¦è¡Œ
        match self.try_receive_packet() {
            Ok(data) => return Ok(data),        // ãƒ‘ã‚±ãƒƒãƒˆãŒã‚ã£ãŸ
            Err(_) => {                         // ãƒ‘ã‚±ãƒƒãƒˆãŒãªã‹ã£ãŸ
                if start.elapsed() > timeout {
                    return Err("Timeout".into()); // åˆ¶é™æ™‚é–“è¶…é
                }
                std::thread::sleep(Duration::from_millis(10)); // å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
            }
        }
    }
}
```

#### ãªãœãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãŒå¿…è¦ï¼Ÿ

**3-way handshakeã§ã¯**:
1. SYNé€ä¿¡
2. **5ç§’ä»¥å†…ã«**SYN-ACKå—ä¿¡ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ãŒå¿…è¦ï¼‰
3. ACKé€ä¿¡

ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆã ã¨ã€SYN-ACKãŒæ¥ãªã„å ´åˆã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒæ°¸ä¹…ã«æ­¢ã¾ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ç‰ˆãªã‚‰ã€10msæ¯ã«ãƒ‘ã‚±ãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¤ã¤ã€5ç§’çµŒã£ãŸã‚‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ãã¾ã™ã€‚

## [TCP ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ç®¡ç†ã«ã¤ã„ã¦]

### è³ªå•å†…å®¹

ã©ã†ã—ã¦complete_handshakeé–¢æ•°å†…ã§ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’+1ã™ã‚‹ã®ã§ã™ã‹ï¼Ÿ
ACKé€ä¿¡æ™‚ã«+1ã™ã‚‹ã®ã§ã¯ã ã‚ã§ã™ã‹ï¼Ÿ

### å›ç­”

#### ãªãœ complete_handshake() ã§ local_seq += 1 ã™ã‚‹ã®ã‹

**TCP ã§ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·æ¶ˆè²»ãƒ«ãƒ¼ãƒ«**ï¼š

TCPã§ã¯ã€ä»¥ä¸‹ã®å ´åˆã«ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ãŒæ¶ˆè²»ï¼ˆ+1ï¼‰ã•ã‚Œã¾ã™ï¼š

1. **SYNãƒ•ãƒ©ã‚°**: 1ãƒã‚¤ãƒˆåˆ†ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’æ¶ˆè²»
2. **FINãƒ•ãƒ©ã‚°**: 1ãƒã‚¤ãƒˆåˆ†ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’æ¶ˆè²»
3. **ãƒ‡ãƒ¼ã‚¿**: ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ãƒˆæ•°åˆ†ã‚’æ¶ˆè²»
4. **ACKã®ã¿**: ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã¯æ¶ˆè²»ã—ãªã„

**3-way handshake ã§ã®æµã‚Œ**ï¼š

```
Client                           Server
CLOSED                           LISTEN
  |                                |
  | SYN seq=1000 ------------>     |  â† ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒSYNã‚’é€ä¿¡
  |                               |
SYN-SENT                          |
  |                              |
  | <---------- SYN-ACK seq=2000, ack=1001  â† ã‚µãƒ¼ãƒãƒ¼ãŒSYN-ACKã‚’è¿”ã™
  |                               |
  | ACK seq=1001, ack=2001 --->   |  â† ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒACKã‚’é€ä¿¡
  |                               |
ESTABLISHED                   ESTABLISHED
```

**ãªãœ complete_handshake() ã§ +1 ã™ã‚‹ã®ã‹**ï¼š

1. **SYNé€ä¿¡æ™‚**: `local_seq = 1000` (ISN)
2. **SYNé€ä¿¡å¾Œ**: SYNãƒ•ãƒ©ã‚°ãŒ1ãƒã‚¤ãƒˆæ¶ˆè²» â†’ æ¬¡ã®seqç•ªå·ã¯`1001`ã«ãªã‚‹ã¹ã
3. **ACKé€ä¿¡æ™‚**: `seq = local_seq + 1 = 1001` ã§é€ä¿¡
4. **æ¥ç¶šç¢ºç«‹å¾Œ**: `local_seq`ã‚’å®Ÿéš›ã®ç¾åœ¨å€¤`1001`ã«æ›´æ–°

**å…·ä½“ä¾‹ã§ã®ç†è§£**ï¼š

```rust
// SYNé€ä¿¡å‰
self.local_seq = 1000;

// SYNé€ä¿¡ï¼ˆcreate_syn_packetå†…ï¼‰
// seq = 1000 ã§é€ä¿¡

// ACKé€ä¿¡ï¼ˆcreate_ack_packetå†…ï¼‰
// seq = self.local_seq + 1 = 1001 ã§é€ä¿¡

// æ¥ç¶šç¢ºç«‹å®Œäº†æ™‚
self.local_seq += 1;  // 1000 â†’ 1001
// ã“ã‚Œã§æ¬¡å›ã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡æ™‚ã¯ seq=1001 ã‹ã‚‰é–‹å§‹
```

**é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ**ï¼š
SYNãƒ•ãƒ©ã‚°ã¯è«–ç†çš„ã«1ãƒã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹ãŸã‚ã€é€ä¿¡å¾Œã¯ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’1ã¤é€²ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¾Œç¶šã®ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã§æ­£ã—ã„ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

#### ACKé€ä¿¡æ™‚ã«+1ã™ã‚‹æ¡ˆã®æ¤œè¨

**ç¾åœ¨ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³**ï¼š
```rust
// send_ack() - ACKé€ä¿¡æ™‚
fn create_ack_packet(&self, ack_number: u32) -> ... {
    TcpHeader::new(
        self.local_port,
        self.remote_port,
        self.local_seq + 1,  // â† ã“ã“ã§+1ã—ã¦é€ä¿¡
        ack_number,
        tcp_flags::ACK,
        8192,
    );
}

// complete_handshake() - æ¥ç¶šç¢ºç«‹æ™‚
fn complete_handshake(&mut self) {
    self.state = TcpState::Established;
    self.local_seq += 1;  // â† ã“ã“ã§å®Ÿéš›ã®å€¤ã‚’æ›´æ–°
}
```

**ä»£æ›¿æ¡ˆï¼šACKé€ä¿¡æ™‚ã«æ›´æ–°**ï¼š
```rust
// send_ack() - ACKé€ä¿¡æ™‚ã«æ›´æ–°
fn send_ack(&mut self, ack_number: u32) -> ... {
    self.local_seq += 1;  // â† ã“ã“ã§æ›´æ–°
    let ack_packet = self.create_ack_packet(ack_number)?;
    // ...
}

fn create_ack_packet(&self, ack_number: u32) -> ... {
    TcpHeader::new(
        self.local_port,
        self.remote_port,
        self.local_seq,  // â† æ—¢ã«æ›´æ–°æ¸ˆã¿ã®å€¤ã‚’ä½¿ç”¨
        ack_number,
        tcp_flags::ACK,
        8192,
    );
}
```

**ç¾åœ¨ã®å®Ÿè£…ã®æ–¹ãŒè‰¯ã„ç†ç”±**ï¼š

1. **è²¬ä»»ã®åˆ†é›¢**
   - `send_ack()`: ãƒ‘ã‚±ãƒƒãƒˆé€ä¿¡ã®è²¬ä»»
   - `complete_handshake()`: çŠ¶æ…‹ç®¡ç†ã®è²¬ä»»

2. **å†åˆ©ç”¨æ€§**
   - `create_ack_packet()`ãŒ`local_seq`ã‚’å¤‰æ›´ã—ãªã„ã®ã§ã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„
   - è¤‡æ•°å›å‘¼ã³å‡ºã—ã¦ã‚‚å‰¯ä½œç”¨ãŒãªã„

3. **ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æ˜ç¢ºæ€§**
   - 3-way handshake **å®Œäº†æ™‚ç‚¹** ã§ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‚’ç¢ºå®š
   - ãƒ‘ã‚±ãƒƒãƒˆé€ä¿¡ã¨çŠ¶æ…‹æ›´æ–°ã‚’åˆ†é›¢

4. **RFCæº–æ‹ **
   - TCPã®çŠ¶æ…‹é·ç§»ã¨ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ç®¡ç†ã‚’æ˜ç¢ºã«åˆ†é›¢

**çµè«–**ï¼š
ç¾åœ¨ã®å®Ÿè£…ï¼ˆ`complete_handshake()`ã§æ›´æ–°ï¼‰ãŒæ¨å¥¨ã§ã™ã€‚ãªãœãªã‚‰ï¼š

- ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã®æ›´æ–°ã¯ã€Œæ¥ç¶šç¢ºç«‹å®Œäº†ã€ã¨ã„ã†çŠ¶æ…‹å¤‰åŒ–ã®ä¸€éƒ¨
- ãƒ‘ã‚±ãƒƒãƒˆé€ä¿¡æ©Ÿèƒ½ã¯å‰¯ä½œç”¨ã‚’æŒãŸãªã„æ–¹ãŒå®‰å…¨
- ãƒ†ã‚¹ãƒˆã‚„å†åˆ©ç”¨ãŒå®¹æ˜“

ãŸã ã—ã€ACKé€ä¿¡æ™‚ã«æ›´æ–°ã™ã‚‹æ¡ˆã‚‚æŠ€è¡“çš„ã«ã¯æ­£ã—ãã€è¨­è¨ˆæ€æƒ³ã®é•ã„ã¨è¨€ãˆã¾ã™ã€‚

## [ãƒ†ã‚¹ãƒˆã‚’ç¹°ã‚Šè¿”ã™ã¨Timeoutã‚¨ãƒ©ãƒ¼ã«ãªã‚‹å•é¡Œ]

### äº‹è±¡

ãƒ†ã‚¹ãƒˆã‚’ä½•åº¦ã‹ç¹°ã‚Šè¿”ã—å®Ÿè¡Œã—ã¦ã„ã‚‹ã¨ã€é€”ä¸­ã‹ã‚‰ãƒ‘ã‚±ãƒƒãƒˆã®å—ä¿¡ã«å¤±æ•—ã—ã€Timeoutã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚

**tcpdumpã®ãƒ­ã‚°ã‹ã‚‰è¦‹ãŸæŒ™å‹•**ï¼š
- æœ€åˆã®3å›ã®æ¥ç¶šï¼šSYN â†’ SYN-ACK â†’ ACKï¼ˆæˆåŠŸï¼‰
- 4å›ç›®ä»¥é™ï¼šSYNé€ä¿¡ â†’ **å¿œç­”ãªã—**ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰SYN-ACKãŒè¿”ã£ã¦ã“ãªã„ï¼‰

### åŸå› 

**æ¥ç¶šçµ‚äº†å‡¦ç†ï¼ˆFINé€ä¿¡ã‚„socketã‚¯ãƒ­ãƒ¼ã‚ºï¼‰ãŒå®Ÿè£…ã•ã‚Œã¦ã„ãªã„ãŸã‚**ã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿï¼š

1. **TCPæ¥ç¶šãŒESTABLISHEDçŠ¶æ…‹ã§æ®‹ã‚Šç¶šã‘ã‚‹**
   ```bash
   $ sudo ip netns exec host2 ss -tan | grep 40000
   LISTEN 2      1           10.0.1.1:40000      0.0.0.0:*
   ESTAB  0      0           10.0.1.1:40000     10.0.0.1:40021
   ESTAB  0      0           10.0.1.1:40000     10.0.0.1:37333
   ESTAB  0      0           10.0.1.1:40000     10.0.0.1:37299
   ```
   - `LISTEN 2 1`: æœ€å¤§ãƒãƒƒã‚¯ãƒ­ã‚°2ã€ç¾åœ¨ã®ã‚­ãƒ¥ãƒ¼1ï¼ˆé™ç•Œã«è¿‘ã„ï¼‰
   - 3ã¤ã®ESTABLISHEDæ¥ç¶šãŒæ®‹ã£ã¦ã„ã‚‹

2. **ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒƒã‚¯ãƒ­ã‚°ãŒã„ã£ã±ã„ã«ãªã‚‹**
   - æ–°ã—ã„æ¥ç¶šã‚’å—ã‘ä»˜ã‘ã‚‰ã‚Œãªããªã‚‹

3. **socket_fdã®ãƒªãƒ¼ã‚¯**
   - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚¿ãŒè§£æ”¾ã•ã‚Œã¦ã„ãªã„
   - ã‚«ãƒ¼ãƒãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹ãŒæ¯æ¸‡

### æ ¹æœ¬åŸå› 

`TcpConnection`ãŒæ¥ç¶šã‚’ç¢ºç«‹ã—ãŸå¾Œã€**`socket_fd`ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦ã„ãªã„**ãŸã‚ï¼š
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒçµ‚äº†ã—ã¦ã‚‚socketãŒé–‹ã„ãŸã¾ã¾
- ã‚µãƒ¼ãƒãƒ¼å´ã§ESTABLISHEDçŠ¶æ…‹ã®æ¥ç¶šãŒæ®‹ã‚‹
- ã‚«ãƒ¼ãƒãƒ«ã«ã‚ˆã‚‹è‡ªå‹•çš„ãªFINé€ä¿¡ã‚‚è¡Œã‚ã‚Œãªã„

### å›é¿ç­–ï¼ˆStep03ã§ã®å¯¾å¿œï¼‰

æ¥ç¶šçµ‚äº†å‡¦ç†ï¼ˆ4-way handshakeã€FINå‡¦ç†ï¼‰ã¯**Step 12ã§å­¦ç¿’ã™ã‚‹å†…å®¹**ã®ãŸã‚ã€Step03ã§ã¯å®Ÿè£…ã—ãªã„ã€‚

#### æ‰‹å‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ–¹æ³•

**æ–¹æ³•1: ESTABLISHEDæ¥ç¶šã‚’å¼·åˆ¶åˆ‡æ–­ï¼ˆæ¨å¥¨ï¼‰**
```bash
# host2ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ï¼‰ã®ESTABLISHEDæ¥ç¶šã‚’ã™ã¹ã¦åˆ‡æ–­
sudo ip netns exec host2 ss -K dst 10.0.0.1
```

**æ–¹æ³•2: ã‚µãƒ¼ãƒãƒ¼ï¼ˆncï¼‰ã‚’å†èµ·å‹•**
```bash
# ncãƒ—ãƒ­ã‚»ã‚¹ã‚’çµ‚äº†
sudo ip netns exec host2 pkill -f "nc -l"

# ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•
sudo ip netns exec host2 nc -l 10.0.1.1 40000 &
```

**æ–¹æ³•3: æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é¸æŠçš„ã«åˆ‡æ–­**
```bash
# ç¾åœ¨ã®æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèª
sudo ip netns exec host2 ss -tan | grep 40000

# ç‰¹å®šã®ãƒãƒ¼ãƒˆã¸ã®æ¥ç¶šã‚’åˆ‡æ–­
sudo ip netns exec host2 ss -K dst 10.0.0.1:37299
```

#### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

```bash
# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
sudo ip netns exec host2 ss -K dst 10.0.0.1 && \
sudo RUST_LOG=info ip netns exec host1 \
  target/debug/deps/step03-ea0032633cd6533a \
  test_complete_handshake --nocapture
```

### å°†æ¥ã®å®Ÿè£…ï¼ˆStep 12ï¼‰

Step 12ã§ä»¥ä¸‹ã‚’å®Ÿè£…äºˆå®šï¼š
- `Drop`ãƒˆãƒ¬ã‚¤ãƒˆã«ã‚ˆã‚‹è‡ªå‹•çš„ãªsocketã‚¯ãƒ­ãƒ¼ã‚º
- FINãƒ‘ã‚±ãƒƒãƒˆã®é€å—ä¿¡
- 4-way handshakeã®å®Ÿè£…
- TIME_WAITçŠ¶æ…‹ã®ç®¡ç†
- é©åˆ‡ãªãƒªã‚½ãƒ¼ã‚¹è§£æ”¾

**å‚è€ƒï¼šå°†æ¥å®Ÿè£…ã™ã‚‹Dropãƒˆãƒ¬ã‚¤ãƒˆ**ï¼ˆStep 12ã§å­¦ç¿’ï¼‰
```rust
impl Drop for TcpConnection {
    fn drop(&mut self) {
        // socket_fdã‚’å®‰å…¨ã«ã‚¯ãƒ­ãƒ¼ã‚º
        if self.socket_fd >= 0 {
            unsafe {
                libc::close(self.socket_fd);
            }
        }
    }
}
```

### å­¦ã‚“ã ãƒã‚¤ãƒ³ãƒˆ

- TCPã¯æ¥ç¶šæŒ‡å‘ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã€**æ¥ç¶šç¢ºç«‹ã¨æ¥ç¶šçµ‚äº†ã¯å¯¾ã«ãªã‚‹å‡¦ç†**
- æ¥ç¶šçµ‚äº†å‡¦ç†ã‚’å®Ÿè£…ã—ãªã„ã¨ã€ã‚«ãƒ¼ãƒãƒ«ãƒªã‚½ãƒ¼ã‚¹ãŒãƒªãƒ¼ã‚¯ã™ã‚‹
- å­¦ç¿’æ®µéšã§ã¯ã€é©åˆ‡ãªå›é¿ç­–ã‚’ä½¿ã£ã¦æ®µéšçš„ã«å®Ÿè£…ã‚’é€²ã‚ã‚‹ã“ã¨ãŒé‡è¦
- æœ¬ç•ªç’°å¢ƒã§ã¯ã€å¿…ãšæ¥ç¶šçµ‚äº†å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
